# 记一次项目内存异常的排查过程与解决

## 问题描述与分析

### 问题场景

我司在做一款 AI 问答应用，在 A 同学的一个新功能上线后，问答页面在问多轮问题后，会出现页面崩溃的问题，在内存不高的老旧电脑上尤其明显。在 A 同学排查无果后，我决定伸出援手。

在观察反复复现的过程后，我总结了以下问题规律：

1. 新功能的范围在问答页面回答问题的辅助功能，其中包含对回答问题的 Markdown 的样式定制。
2. 页面崩溃发生在询问会返回代码的问题后，且需要大量的类似问题回答才会触发。
3. 页面奔溃的错误代码为 Out of Memory，这能确定是内存溢出引起的。

### 问题分析

由观察到的现象和规律，我分析出新功能范围内可能造成问题的地方：

1. 回答打字机效果的实现

这个功能是我在最初版本实现的，所以对这印象很深。由于实现用了 `setTimeout` 这个 api，确实存在泄露的风险。但考虑到奔溃问题在这次新版本出现，并未在此前的版本出现过，所以需要去确定一下新版本是否有动到这个功能 `clearTimeout` 的地方。

2. 代码样式渲染相关代码

这个功能既有大量我们的代码逻辑，又使用了很多第三方库，所以需要借助 chrome 的 memory 相关工具确定问题源。

## 问题排查与定位

### 确定打字机效果

通过阅读新版本代码，确定并未动到 `clearTimeout` 的地方，可暂时排除此处。

